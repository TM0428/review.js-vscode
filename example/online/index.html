<!DOCTYPE html>
<html>
<head>
    <title>ReVIEW.js 利用サンプル</title>
    <script type="application/javascript" src="../../bin/lib/i18next-1.6.3.js"></script>
    <script type="application/javascript" src="../../bin/review.js"></script>

    <script type="application/javascript" src="jquery-2.0.3.js"></script>

    <style type="text/css">
        .info {
            color: blue;
        }

        .warn {
            color: orange;
        }

        .error {
            color: tomato;
        }
    </style>
</head>
<body>

<div id="info">
</div>

<textarea id="input">
</textarea>

<pre id="result">
    コンパイル結果がここに出る。
</pre>

<script type="application/javascript">
    if (!window.ReVIEW) {
        var $child = $("<div>").appendTo($("#info"));
        $child.addClass("error");
        $child.html("ReVIEW関連ファイルが正しく読み込めていません。<br>grunt default を実行してください。");
    } else {
        var $input = $("#input");
        $input.val('={sample} これが、これがサンプルだ！\n@<hd>{sample} を開始する！\n//list[hoge][きゃぷしょん]{\nalert("hello");\n//}\n@<list>{hoge}はJavaScriptのコードです。');
        $input.on("keyup", function () {
            doCompile($input.val());
        });
        doCompile($input.val())
    }

    function doCompile(text) {
        var files = {
            "./ch01.re": text
        };
        var result = {
        };
        ReVIEW.start(function (review) {
            review.initConfig({
                read: function (path) {
                    return files[path];
                },
                write: function (path, content) {
                    result[path] = content;
                },

                compileSuccess: function (book) {
                    var result = book.parts[1].chapters[0].process.result;
                    $("#result").text(result);
                },

                outputReport: function (reports) {
                    outputReports(reports);
                },

                builders: [new ReVIEW.Build.TextBuilder()],

                book: {
                    preface: [
                    ],
                    chapters: [
                        "ch01.re"
                    ],
                    afterword: [
                    ]
                }
            });
        });
    }

    function outputReports(reports) {
        var $base = $("#info").empty();
        reports.forEach(function (report, i) {
            var $child = $("<div>").appendTo($base);
            switch (report.level) {
                case ReVIEW.ReportLevel.Info:
                    $child.addClass("info");
                case ReVIEW.ReportLevel.Warning:
                    $child.addClass("warn");
                case ReVIEW.ReportLevel.Error:
                    $child.addClass("error");
            }
            var message = "";
            report.nodes.forEach(function (node) {
                message += "[" + node.line + "," + node.column + "] ";
            });
            message += report.message;
            $child.text(message);
        });
    }
</script>
</body>
</html>